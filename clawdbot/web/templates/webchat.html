{% extends "base.html" %}

{% block title %}WebChat - ClawdBot{% endblock %}

{% block extra_head %}
<style>
    .chat-container {
        height: calc(100vh - 250px);
        display: flex;
        flex-direction: column;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 8px;
        overflow: hidden;
    }

    .messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 8px;
        max-width: 80%;
    }

    .message.user {
        background: #3b82f6;
        margin-left: auto;
        text-align: right;
    }

    .message.assistant {
        background: #1e40af;
        margin-right: auto;
    }

    .message.system {
        background: #64748b;
        margin: 10px auto;
        text-align: center;
        max-width: 60%;
        font-size: 0.9rem;
        color: #cbd5e1;
    }

    .input-area {
        display: flex;
        gap: 10px;
        padding: 20px;
        background: #0f172a;
        border-top: 1px solid #334155;
    }

    .input-area input {
        flex: 1;
        padding: 12px;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 6px;
        color: #e2e8f0;
        font-size: 1rem;
    }

    .input-area input:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .input-area button {
        padding: 12px 24px;
    }

    .typing-indicator {
        display: none;
        padding: 12px;
        color: #94a3b8;
        font-style: italic;
    }

    .typing-indicator.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="messages" id="messages">
        <div class="message system">
            Welcome to ClawdBot WebChat! Start a conversation below.
        </div>
    </div>
    <div class="typing-indicator" id="typing">
        Assistant is typing...
    </div>
    <div class="input-area">
        <input type="text" id="messageInput" placeholder="Type your message..." 
               onkeypress="handleKeyPress(event)">
        <button class="btn" onclick="sendMessage()">Send</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let ws = null;

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
        console.log('WebSocket connected');
        addSystemMessage('Connected to server');
    };
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log('Received:', data);
        
        if (data.type === 'chat_response') {
            hideTyping();
            addAssistantMessage(data.text);
        }
    };
    
    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        addSystemMessage('Connection error');
    };
    
    ws.onclose = () => {
        console.log('WebSocket disconnected');
        addSystemMessage('Disconnected from server');
        setTimeout(connectWebSocket, 3000);
    };
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || !ws || ws.readyState !== WebSocket.OPEN) {
        return;
    }
    
    // Add user message to UI
    addUserMessage(message);
    
    // Send to server
    ws.send(JSON.stringify({
        type: 'chat',
        text: message
    }));
    
    // Clear input
    input.value = '';
    
    // Show typing indicator
    showTyping();
}

function addUserMessage(text) {
    const messagesDiv = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message user';
    messageDiv.textContent = text;
    messagesDiv.appendChild(messageDiv);
    scrollToBottom();
}

function addAssistantMessage(text) {
    const messagesDiv = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message assistant';
    messageDiv.textContent = text;
    messagesDiv.appendChild(messageDiv);
    scrollToBottom();
}

function addSystemMessage(text) {
    const messagesDiv = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message system';
    messageDiv.textContent = text;
    messagesDiv.appendChild(messageDiv);
    scrollToBottom();
}

function showTyping() {
    document.getElementById('typing').classList.add('active');
}

function hideTyping() {
    document.getElementById('typing').classList.remove('active');
}

function scrollToBottom() {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Connect on page load
connectWebSocket();
</script>
{% endblock %}
